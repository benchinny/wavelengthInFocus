%%

function [defocusLCAmeasured, q1best, q2best, q3best,defocusLCAmeasuredBoots,Dgreen,dprimeFitAll,PCfitSupport] = ARCacuAnalysisLCA(subj,bPLOT,nBoots,dataPath)

if ispc
    slash = '\';
else
    slash = '/';
end
dataDirectory = [dataPath 'data' slash 'ARC' slash];

% DATA TO LOAD
if subj==1
    filenames = {
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410290922.mat'] ...
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410290936.mat'] ...
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410290949.mat'] ...  
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410291002.mat'] ...    
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410291014.mat'] ...     
                 [dataDirectory 'S1011V18_AFC_RightACL0_2410291029.mat'] ...
                 [dataDirectory 'S1011V18_AFC_RightACL0_2411050914.mat'] ...
                 }; 
elseif subj==3
    filenames = {
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191523.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191540.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191547.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191554.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191609.mat'] ... 
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191616.mat'] ... 
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191631.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191640.mat'] ... 
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409191650.mat'] ...     
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409201521.mat'] ...
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409201515.mat'] ... 
                 [dataDirectory 'S1013V19_AFC_RightACL0_2409201508.mat'] ...                      
                 };            
elseif subj==10
    filenames = {
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171805.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171756.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171749.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171741.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171734.mat'] ... 
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171728.mat'] ... 
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171722.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171715.mat'] ... 
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171707.mat'] ... 
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171701.mat'] ... 
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171654.mat'] ...
                 [dataDirectory 'S1020V11_AFC_RightACL0_2409171645.mat'] ...                  
                 };            
elseif subj==8
    filenames = {
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241724.mat'] ...
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241714.mat'] ...
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241707.mat'] ...
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241700.mat'] ...
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241653.mat'] ... 
                 [dataDirectory 'S1018V17_AFC_RightACL0_2409241646.mat'] ...                 
                 };                
elseif subj==16
    filenames = {
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251353.mat'] ...
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251346.mat'] ...
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251339.mat'] ...
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251331.mat'] ...
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251322.mat'] ... 
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251315.mat'] ...   
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251308.mat'] ... 
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251300.mat'] ...     
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251253.mat'] ...     
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409251246.mat'] ...    
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409261655.mat'] ...     
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409261649.mat'] ...     
                 [dataDirectory 'S1026V9_AFC_RightACL0_2409261643.mat'] ...                     
                 }; 
elseif subj==5
    filenames = {
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261217.mat'] ...
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261208.mat'] ...
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261202.mat'] ...
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261155.mat'] ...
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261149.mat'] ... 
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261143.mat'] ...   
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261136.mat'] ... 
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261130.mat'] ...     
                 [dataDirectory 'S1015V10_AFC_RightACL0_2409261122.mat'] ...     
                 [dataDirectory 'S1015V10_AFC_RightACL0_2410031542.mat'] ... 
                 [dataDirectory 'S1015V10_AFC_RightACL0_2410031551.mat'] ...     
                 [dataDirectory 'S1015V10_AFC_RightACL0_2410031559.mat'] ...                      
                 };     
elseif subj==9
    filenames = {
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409301015.mat'] ...
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409301009.mat'] ...
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409301002.mat'] ...
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300956.mat'] ...
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300949.mat'] ... 
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300942.mat'] ...   
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300935.mat'] ... 
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300929.mat'] ...     
                 [dataDirectory 'S1019V9_AFC_RightACL0_2409300921.mat'] ...     
                 [dataDirectory 'S1019V9_AFC_RightACL0_2410041214.mat'] ... 
                 [dataDirectory 'S1019V9_AFC_RightACL0_2410041221.mat'] ...     
                 [dataDirectory 'S1019V9_AFC_RightACL0_2410041229.mat'] ...                      
                 };         
elseif subj==17
    filenames = {
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031133.mat'] ...
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031126.mat'] ...
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031110.mat'] ...
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031102.mat'] ...
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031049.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031041.mat'] ...   
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031033.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410031023.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410081020.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410081027.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410081033.mat'] ... 
                 [dataDirectory 'S1027V9_AFC_RightACL0_2410081045.mat'] ... 
                 };             
elseif subj==18
    filenames = {
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011027.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011020.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011011.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011035.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011043.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011050.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011107.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411011114.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411051339.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411051327.mat'] ...
                 [dataDirectory 'S1028V9_AFC_RightACL0_2411051313.mat'] ...
                 };                 
elseif subj==20
    filenames = {
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411041452.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411041441.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411041426.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411041416.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151008.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151021.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151031.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151041.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151052.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151102.mat'] ...
                 [dataDirectory 'S1030V8_AFC_RightACL0_2411151112.mat'] ...
                 };                     
end

rgb = []; % COLOR CONDITIONS OF ACCOMMODATIVE STIMULUS--ALWAYS THE SAME
meanFocstmOptDst = []; % ACCOMMODATIVE STIMULUS DISTANCE
focStmOptDstIncr = []; % ACUITY STIMULUS DISTANCE
rspAcu = []; % RESPONSES
stimOrientation = []; % STIM ORIENTATION: 1 FOR -15 DEG, 2 FOR 15 DEG
indAcuRB = []; % 1 FOR RED, 2 FOR GREEN, 3 FOR BLUE

for i = 1:length(filenames)
    load(filenames{i}); % LOAD FILE
    % STACK UP VARIABLES REQUIRED FOR ANALYSIS INTO COLUMNS
    rgb = [rgb; AFCp.rgb]; 
    meanFocstmOptDst = [meanFocstmOptDst; AFCp.meanFocstmOptDst];
    focStmOptDstIncr = [focStmOptDstIncr; AFCp.focStmOptDstIncr];
    rspAcu = [rspAcu; AFCp.rspAcu'];
    stimOrientation = [stimOrientation; AFCp.stimOrientation];
    indAcuRB = [indAcuRB; AFCp.indAcuRGBall(1:end-1)];
end

% COLORS FOR PLOTTING
rgbUnq = [1 0 0; 0 1 0; 0 0 1];

scaleFac = 0.816; % ACCOUNT FOR OPTICAL PROPERTIES OF BVAMS

if bPLOT
    figure;
end

defocusLCAmeasured = []; % BEST DISTANCE
dprimeFitAll = {}; % D PRIMES
for rgbAcuCnd = 1:3 % SORrgbAcuCndT DATA BY COLOR
    unqFocDst = unique(focStmOptDstIncr(indAcuRB==rgbAcuCnd));
    for i = 1:length(unqFocDst) % LOOP OVER STIMULUS DISTANCE
        indAnalysis = abs(focStmOptDstIncr-unqFocDst(i))<0.001 & indAcuRB==rgbAcuCnd;
        % PERCENT CORRECT
        PC(i) = sum(rspAcu(indAnalysis)==stimOrientation(indAnalysis))./sum(indAnalysis);
        % 95% CONFIDENCE INTERVALS
        PCci(:,i) = binoinv([0.025 0.975],sum(focStmOptDstIncr==unqFocDst(i) & indAcuRB==rgbAcuCnd),PC(i))./sum(focStmOptDstIncr==unqFocDst(i) & indAcuRB==rgbAcuCnd);
    end

    % FITTING SPLINE TO DATA
    PCfitSupport = min(unqFocDst.*scaleFac):0.01:max(unqFocDst.*scaleFac);
    PCfit = spline(unqFocDst.*scaleFac,PC,PCfitSupport);
    % PROTECT AGAINST IMPLAUSIBLE PEAK VALUES FROM MEASUREMENT NOISE OR
    % MONOCHROMATIC ABERRATIONS BY ENFORCING CONSTRAINT THAT PEAK FOR 
    % GREEN IS WITHIN 1.0D OF PEAK FOR RED, AND PEAK FOR BLUE IS WITHIN 
    % 1.0D OF PEAK FOR GREEN
    if rgbAcuCnd==2 || rgbAcuCnd==3
        indValid = abs(PCfitSupport-defocusLCAmeasured(rgbAcuCnd-1))<1;
        PCfitSupportValid = PCfitSupport(indValid);
        PCfitValid = PCfit(indValid);
        [~,indLCA] = max(PCfitValid);
        defocusLCAmeasured(rgbAcuCnd) = PCfitSupportValid(indLCA);   
    else
        [~,indLCA] = max(PCfit);
        defocusLCAmeasured(rgbAcuCnd) = PCfitSupport(indLCA);        
    end
    if bPLOT
        hold on;
        plot(PCfitSupport,PCfit,'-','Color',rgbUnq(rgbAcuCnd,:),'MarkerFaceColor','w','LineWidth',2,'MarkerSize',20);
        plot(unqFocDst.*scaleFac,PC,'o','Color',rgbUnq(rgbAcuCnd,:),'MarkerFaceColor','w','LineWidth',2,'MarkerSize',20);
        errorbar(unqFocDst.*scaleFac,PC,PC-PCci(1,:),PCci(2,:)-PC,'o','Color',rgbUnq(rgbAcuCnd,:),'MarkerFaceColor','w','LineWidth',2,'MarkerSize',20);
        ylim([0.4 1]);
        if rgbAcuCnd==1
           formatFigure('Relative optical distance (D)','Proportion Correct',['Subject ' num2str(subj)]);
        else
           formatFigure('Relative optical distance (D)','Proportion Correct'); 
        end
    end
    epsilonPC = 0.999;
    PCfit(PCfit>epsilonPC) = epsilonPC;
    dprimeFitAll{rgbAcuCnd} = 2*norminv(PCfit);
end

% THE BLOCK OF CODE BELOW DOES BOOTSTRAPPING
defocusLCAmeasuredBoots = []; % BOOTSTRAPPING BEST DISTANCE VALUES
if nBoots>1
    defocusLCAmeasuredTmp = [];
    for j = 1:nBoots
        for rgbAcuCnd = 1:3 % SORrgbAcuCndT DATA BY COLOR
            unqFocDstBoots = unique(focStmOptDstIncr(indAcuRB==rgbAcuCnd));
            for i = 1:length(unqFocDstBoots) % LOOP OVER STIMULUS DISTANCE
                indAnalysisBoots = abs(focStmOptDstIncr-unqFocDstBoots(i))<0.001 & indAcuRB==rgbAcuCnd;
                % COMPUTE PERCENT CORRECT
                indBoots = randsample(find(indAnalysisBoots),sum(indAnalysisBoots),'true');                
                % PERCENT CORRECT
                PCboots(i) = sum(rspAcu(indBoots)==stimOrientation(indBoots))./sum(indBoots);
            end
        
            % FITTING SPLINE TO DATA
            PCfitSupportBoots = min(unqFocDstBoots.*scaleFac):0.01:max(unqFocDstBoots.*scaleFac);
            PCfitBoots = spline(unqFocDstBoots.*scaleFac,PCboots,PCfitSupportBoots);
            % PROTECT AGAINST IMPLAUSIBLE PEAK VALUES FROM MEASUREMENT NOISE OR
            % MONOCHROMATIC ABERRATIONS BY ENFORCING CONSTRAINT THAT PEAK FOR 
            % GREEN IS WITHIN 1.0D OF PEAK FOR RED, AND PEAK FOR BLUE IS WITHIN 
            % 1.0D OF PEAK FOR GREEN
            if rgbAcuCnd==2 || rgbAcuCnd==3
                indValidBoots = abs(PCfitSupportBoots-defocusLCAmeasuredTmp(rgbAcuCnd-1))<1;
                PCfitSupportValidBoots = PCfitSupportBoots(indValidBoots);
                PCfitValidBoots = PCfitBoots(indValidBoots);
                [~,indLCAboots] = max(PCfitValidBoots);
                defocusLCAmeasuredTmp(rgbAcuCnd) = PCfitSupportValidBoots(indLCAboots);   
            else
                [~,indLCAboots] = max(PCfitBoots);
                defocusLCAmeasuredTmp(rgbAcuCnd) = PCfitSupportBoots(indLCAboots);        
            end
            epsilonPC = 0.999;
            PCfitBoots(PCfitBoots>epsilonPC) = epsilonPC;
        end
        defocusLCAmeasuredBoots(:,j) = defocusLCAmeasuredTmp;
    end
end

wavePlotLCA = 380:875; % SUPPORT FOR LCA FUNCTION
wavePlotPrimaries = [616 533 468]; % PEAK WAVELENGTHS OF PRIMARIES
nRepeatFit = 100; % NUMBER OF TIMES TO REPEAT FIT
% LCA PARAMETERS
q1all = [];
q2all = [];
q3all = [];
errAll = [];
% REPEATING FIT OF LCA FUNCTION TO ACCOUNT FOR INSTABILITIES
for i = 1:nRepeatFit
   [q1,q2,q3,err] = ARC_LCAfit(wavePlotPrimaries,-defocusLCAmeasured);
   q1all(i) = q1;
   q2all(i) = q2;
   q3all(i) = q3;
   errAll(i) = err;
   if mod(i,1000)==0
       display(['Iteration ' num2str(i)]);
   end
end
% GET BEST OF REPEATED FITS
[~,indBestFit] = min(errAll);
q1best = q1all(indBestFit);
q2best = q2all(indBestFit);
q3best = q3all(indBestFit);
% DEFOCUS AT GREEN (NOT CURRENTLY USING BUT COULD FOR OTHER PURPOSES)
Dgreen = humanWaveDefocusParameterized(532,q1best,q2best,q3best);

if bPLOT
    figure; 
    hold on;
    plot(wavePlotLCA,humanWaveDefocusParameterized(wavePlotLCA,q1best,q2best,q3best),'k-','LineWidth',1); 
    plot(wavePlotPrimaries,-defocusLCAmeasured,'ko','MarkerSize',15,'MarkerFaceColor','w');
    axis square; 
    set(gca,'FontSize',15); 
    xlabel('Wavelength (\lambda)'); 
    ylabel('Relative Defocus (D)');
    xlim([400 875]);
end

end
