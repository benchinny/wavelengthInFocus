function thresholds = ARCnlz_contrastThresholds(subjNum,bPLOT,dataPath)

% Loads data from contrast calibration task for the acuity and LCA-measuring tasks.
% Then, makes psychometric functions and returns thresholds.
% use subjNums 1, 3, 5, 10, 16, 17, 18, 20
% example of dataPath:
%  dataPath = 'C:\Users\bmccis\OneDrive - rit.edu\Documents\wavelengthInFocusData\';

rng(1); % FIX RANDOM SEED
foldername = fullfile(dataPath,'data','psychophysicalData');

% CRITERION PERFORMANCE AT WHICH THRESHOLD IS DEFINED
thresholdCriterion = 0.85;

if subjNum==10
    filenames = {
        'S1020V1_AFC_RightACL0_2409091343.mat' ...
        'S1020V1_AFC_RightACL0_2409091344.mat' ...
        'S1020V1_AFC_RightACL0_2409091347.mat' ...
        'S1020V1_AFC_RightACL0_2409091352.mat' ...
        'S1020V1_AFC_RightACL0_2409091357.mat' ...
        'S1020V1_AFC_RightACL0_2409091400.mat' ...
        'S1020V1_AFC_RightACL0_2409091404.mat' ...
        'S1020V1_AFC_RightACL0_2409091407.mat' ...
        'S1020V1_AFC_RightACL0_2409091410.mat' ...
        'S1020V1_AFC_RightACL0_2409091414.mat' ...
        'S1020V1_AFC_RightACL0_2409091416.mat' ...
        'S1020V1_AFC_RightACL0_2409091420.mat' ...
        'S1020V9_AFC_RightACL0_2409111540.mat' ...
        'S1020V9_AFC_RightACL0_2409111542.mat' ...
        'S1020V9_AFC_RightACL0_2409111544.mat' ...
        };
elseif subjNum==1
    filenames = {
        'S1011V17_AFC_RightACL0_2409100948.mat' ...
        'S1011V17_AFC_RightACL0_2409100949.mat' ...
        'S1011V17_AFC_RightACL0_2409100955.mat' ...
        'S1011V17_AFC_RightACL0_2409101002.mat' ...
        'S1011V17_AFC_RightACL0_2409101007.mat' ...
        'S1011V17_AFC_RightACL0_2409101014.mat' ...
        'S1011V17_AFC_RightACL0_2409101019.mat' ...
        };
elseif subjNum==3
    filenames = {
        'S1013V18_AFC_RightACL0_2409171533.mat' ...
        'S1013V18_AFC_RightACL0_2409171535.mat' ...
        'S1013V18_AFC_RightACL0_2409171543.mat' ...
        'S1013V18_AFC_RightACL0_2409171547.mat' ...
        'S1013V18_AFC_RightACL0_2409171559.mat' ...
        'S1013V18_AFC_RightACL0_2409171604.mat' ...
        'S1013V18_AFC_RightACL0_2409171610.mat' ...
        };
elseif subjNum==5
    filenames = {
        'S1015V9_AFC_RightACL0_2409181657.mat' ...
        'S1015V9_AFC_RightACL0_2409181652.mat' ...
        'S1015V9_AFC_RightACL0_2409181650.mat' ...
        'S1015V9_AFC_RightACL0_2409181648.mat' ...
        'S1015V9_AFC_RightACL0_2409181646.mat' ...
        'S1015V9_AFC_RightACL0_2409181639.mat' ...
        'S1015V9_AFC_RightACL0_2409181633.mat' ...
        'S1015V9_AFC_RightACL0_2409181622.mat' ...
        };
elseif subjNum==16
    filenames = {
        'S1026V1_AFC_RightACL0_2409161339.mat' ...
        'S1026V1_AFC_RightACL0_2409161341.mat' ...
        'S1026V1_AFC_RightACL0_2409161343.mat' ...
        'S1026V1_AFC_RightACL0_2409161347.mat' ...
        'S1026V1_AFC_RightACL0_2409161350.mat' ...
        'S1026V1_AFC_RightACL0_2409161353.mat' ...
        'S1026V1_AFC_RightACL0_2409161359.mat' ...
        'S1026V1_AFC_RightACL0_2409161403.mat' ...
        'S1026V1_AFC_RightACL0_2409161408.mat' ...
        };
elseif subjNum==17
    filenames = {
        'S1027V8_AFC_RightACL0_2409241158.mat' ...
        'S1027V8_AFC_RightACL0_2409241150.mat' ...
        'S1027V8_AFC_RightACL0_2409241141.mat' ...
        'S1027V8_AFC_RightACL0_2409241134.mat' ...
        'S1027V9_AFC_RightACL0_2410081122.mat' ...
        'S1027V9_AFC_RightACL0_2410081121.mat' ...
        };
elseif subjNum==18
    filenames = {
        'S1028V8_AFC_RightACL0_2409271127.mat' ...
        'S1028V8_AFC_RightACL0_2409271124.mat' ...
        'S1028V8_AFC_RightACL0_2409271120.mat' ...
        'S1028V8_AFC_RightACL0_2409271117.mat' ...
        'S1028V8_AFC_RightACL0_2409271109.mat' ...
        'S1028V8_AFC_RightACL0_2409271106.mat' ...
        'S1028V9_AFC_RightACL0_2411051403.mat' ...
        };
elseif subjNum==20
    filenames = {
        'S1030V8_AFC_RightACL0_2410311629.mat' ...
        'S1030V8_AFC_RightACL0_2410311627.mat' ...
        'S1030V8_AFC_RightACL0_2410311620.mat' ...
        'S1030V8_AFC_RightACL0_2410311618.mat' ...
        'S1030V1_AFC_RightACL0_2410041052.mat' ...
        'S1030V1_AFC_RightACL0_2410041047.mat' ...
        'S1030V1_AFC_RightACL0_2410041038.mat' ...
        'S1030V1_AFC_RightACL0_2410041034.mat' ...
        'S1030V1_AFC_RightACL0_2410041030.mat' ...
        'S1030V1_AFC_RightACL0_2410041025.mat' ...
        'S1030V8_AFC_RightACL0_2411151117.mat' ...
        };
end

for i = 1:length(filenames) % LOOP OVER FILENAMES
    load(fullfile(foldername,filenames{i})); % LOAD
    lengthRsp = length(AFCp.rspAcu); % NUM RESPONSES
    AFCp.t3 = AFCp.t3(1:lengthRsp,:,:); % STIMULUS APPEARANCE TIME
    AFCp.rgb = AFCp.rgb(1:lengthRsp,:); % STIMULUS COLOR
    AFCp.meanFocstmOptDst = AFCp.meanFocstmOptDst(1:lengthRsp); % STIM DISTANCE
    AFCp.contrast = AFCp.contrast(1:lengthRsp); % STIM CONTRAST
    AFCp.rspAcu = AFCp.rspAcu'; % RESPONSE
    % '1' is -15 deg, '2' is +15deg
    AFCp.stimOrientation = AFCp.stimOrientation(1:lengthRsp); % STIM ORIENTATION
    if i==1
        AFCpAll = AFCp;
    else
        AFCpAll = structmerge(AFCpAll,AFCp); % MERGE DATA FROM VARIOUS FILES
    end
end

rgbUnq = [0.569 0.000 0.000; ...
    0.000 0.432 0.000; ...
    0.000 0.000 1.000; ...
    0.569 0.000 1.000]; % THESE ARE ALL THE UNIQUE COLOR CONDITIONS

if bPLOT
    figure;
    set(gcf,'Position',[414 281 1013 660]);
end

thresholds = [];
for i = 1:size(rgbUnq,1)

    % GET ALL DATA FROM A GIVEN COLOR
    ind = abs(AFCpAll.rgb(:,1)-rgbUnq(i,1))<0.001 & ...
        abs(AFCpAll.rgb(:,2)-rgbUnq(i,2))<0.001 & ...
        abs(AFCpAll.rgb(:,3)-rgbUnq(i,3))<0.001;
    % FIT PSYCHOMETRIC FUNCTION
    [aFit,bFit,Tfit,PCdta] = psyfitWeibull(AFCpAll.contrast(ind),AFCpAll.rspAcu(ind)==AFCpAll.stimOrientation(ind),[],[],thresholdCriterion);
    thresholds(i) = Tfit;
    contrastIncr = 0.1:0.01:1;
    % PLOT PSYCHOMETRIC FUNCTION
    [PCplt,~]=psyfitWeibullfunc(contrastIncr,aFit,bFit,thresholdCriterion);
    if bPLOT
        subplot(2,2,i);
        hold on;
        plot([1 1].*(Tfit),[min(contrastIncr) 1].*thresholdCriterion,'k--','LineWidth',1);
        plot([min(contrastIncr) 1].*(Tfit),[1 1].*thresholdCriterion,'k--','LineWidth',1);
        plot(contrastIncr,PCplt,'-','Color',rgbUnq(i,:),'LineWidth',1);
        plot(unique(AFCpAll.contrast(ind)),PCdta,'o','Color',rgbUnq(i,:),'LineWidth',1,'MarkerSize',10,'MarkerFaceColor','w');
        axis square;
        xlabel('Contrast');
        ylabel('Proportion correct');
        title(['Subj ' num2str(subjNum) ', Threshold = ' num2str(Tfit,2)]);
        set(gca,'FontSize',15);
        xlim([min(contrastIncr) 1]);
        ylim([0.3 1]);
    end
end

end